<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Converti Estratti Conto → CSV</title>
    <meta name="description" content="Tool self‑hosted per convertire estratti conto bancari in CSV pronti per i gestionali" />

    <!-- Tailwind CSS (CDN build) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
      :root { color-scheme: light dark; }
      html { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
      /* Smooth fade-in */
      body { opacity: 0; transition: opacity .3s ease; }
      body.ready { opacity: 1; }
      /* Hide default file input */
      input[type="file"] { display: none; }
    </style>
  </head>
  <body class="ready bg-gradient-to-b from-slate-50 to-white dark:from-slate-950 dark:to-slate-900 min-h-screen text-slate-800 dark:text-slate-100">
    <header class="px-6 py-4">
      <div class="max-w-5xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-2xl bg-slate-900 dark:bg-white flex items-center justify-center shadow-sm">
            <!-- Bank/card icon -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-white dark:text-slate-900" aria-hidden="true">
              <path d="M3 10h18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
              <rect x="3" y="6" width="18" height="12" rx="2.2" stroke="currentColor" stroke-width="1.8"/>
              <path d="M6.5 15h5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-semibold">Estratti Conto → CSV</h1>
            <p class="text-sm text-slate-500 dark:text-slate-400">Pagina semplice e moderna. 100% self‑hosted.</p>
          </div>
        </div>
        <a href="#" class="text-sm text-slate-500 hover:text-slate-700 dark:hover:text-slate-200" id="how-it-works">Come funziona</a>
      </div>
    </header>

    <main class="px-4 sm:px-6 pb-24 pt-6">
      <div class="max-w-3xl mx-auto">
        <div class="rounded-3xl border border-slate-200/70 dark:border-slate-800 bg-white/80 dark:bg-slate-950/60 shadow-sm backdrop-blur p-8 md:p-10">
          <div class="space-y-3 text-center">
            <h2 class="text-2xl font-semibold tracking-tight">Carica il tuo estratto conto</h2>
            <p class="text-slate-500 dark:text-slate-400 max-w-2xl mx-auto">Il file verrà convertito in <span class="font-medium text-slate-700 dark:text-slate-200">CSV</span> pronto per l'importazione nel gestionale.</p>
            <ul class="text-sm text-slate-500 dark:text-slate-400 space-y-1 max-w-xl mx-auto">
              <li>• Formati supportati: PDF, CSV, XLS, XLSX, OFX, QIF.</li>
              <li>• I dati restano sul tuo server: nessun upload verso servizi terzi.</li>
            </ul>
          </div>

          <!-- Dropzone / Uploader -->
          <label for="file-input" id="dropzone" class="mt-8 block rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-700 p-12 text-center cursor-pointer hover:border-slate-400 dark:hover:border-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-500/40">
            <div class="flex flex-col items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 16V7m0 0-3.5 3.5M12 7l3.5 3.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M20 16.5a4.5 4.5 0 0 0-4.5-4.5h-7A4.5 4.5 0 0 0 4 16.5c0 2.485 2.015 4.5 4.5 4.5H15" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <div class="space-y-1">
                <p class="font-medium">Trascina qui il file</p>
                <p class="text-sm text-slate-500 dark:text-slate-400">oppure <span class="underline">selezionalo dal dispositivo</span></p>
              </div>
              <p class="text-xs text-slate-400">Dimensione massima consigliata: 20 MB</p>
            </div>
            <input id="file-input" type="file" accept=".pdf,.csv,.xls,.xlsx,.ofx,.qif,application/pdf,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/csv,application/x-ofx,application/qif" />
          </label>

          <!-- File badge -->
          <div id="file-badge" class="hidden mt-6 flex items-center justify-between rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 p-4 max-w-md mx-auto">
            <div class="flex items-center gap-3 min-w-0">
              <div class="h-9 w-9 rounded-lg bg-slate-200 dark:bg-slate-800 grid place-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M7 3h6l5 5v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1Z" stroke="currentColor" stroke-width="1.5"/>
                  <path d="M13 3v5h5" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </div>
              <div class="min-w-0">
                <p id="file-name" class="text-sm font-medium truncate">file.pdf</p>
                <p id="file-size" class="text-xs text-slate-500 dark:text-slate-400">0 KB</p>
              </div>
            </div>
            <button id="remove-file" class="text-sm px-3 py-1.5 rounded-lg bg-slate-200 hover:bg-slate-300 dark:bg-slate-800 dark:hover:bg-slate-700">Rimuovi</button>
          </div>

          <!-- Actions -->
          <div class="mt-8 flex items-center justify-center gap-3">
            <button id="convert-btn" disabled class="inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2.5 text-sm font-medium text-white bg-slate-900 disabled:opacity-40 disabled:cursor-not-allowed hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-500/40">
              <svg id="convert-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Converti in CSV</span>
            </button>
            <button id="reset-btn" class="text-sm px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Reset</button>
          </div>

          <!-- Progress / Alerts -->
          <div id="progress" class="hidden mt-8">
            <div class="w-full max-w-md mx-auto bg-slate-200 dark:bg-slate-800 rounded-full h-2 overflow-hidden">
              <div id="progress-bar" class="h-2 bg-slate-900 dark:bg-white rounded-full w-0 transition-all"></div>
            </div>
            <p id="progress-text" class="mt-3 text-sm text-center text-slate-500 dark:text-slate-400">Preparazione…</p>
          </div>

          <div id="alert" class="hidden mt-8 rounded-xl border p-4 text-sm text-center max-w-2xl mx-auto"></div>

          <!-- Output -->
          <div id="result" class="hidden mt-8 space-y-6">
            <!-- Success message + Download -->
            <div class="rounded-xl border border-emerald-300/60 dark:border-emerald-700/60 bg-emerald-50/60 dark:bg-emerald-900/40 p-5 text-center">
              <p class="text-sm font-medium mb-3">✅ Conversione completata con successo!</p>
              <div class="flex items-center justify-center gap-3">
                <a id="download-link" class="inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 transition-colors" download>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12m0 0 4-4m-4 4-4-4M4 21h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <span>Scarica CSV</span>
                </a>
                <button id="copy-btn" class="inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 text-sm font-medium border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                    <rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="1.8"/>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="1.8"/>
                  </svg>
                  <span>Copia</span>
                </button>
              </div>
            </div>

            <!-- Preview window -->
            <div class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 overflow-hidden">
              <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 flex items-center justify-between">
                <h3 class="text-sm font-medium text-slate-700 dark:text-slate-300">Anteprima CSV</h3>
                <span id="preview-lines" class="text-xs text-slate-500 dark:text-slate-400"></span>
              </div>
              <div class="overflow-auto" style="max-height: 400px;">
                <pre id="csv-preview" class="p-4 text-xs font-mono text-slate-800 dark:text-slate-200 whitespace-pre leading-relaxed"></pre>
              </div>
            </div>
          </div>

          <!-- Helper: How it works -->
          <dialog id="how-dialog" class="rounded-2xl p-0 backdrop:bg-black/40">
            <div class="w-[90vw] max-w-lg rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6">
              <h3 class="text-lg font-semibold">Come funziona</h3>
              <ol class="mt-3 space-y-2 text-sm text-slate-600 dark:text-slate-300 list-decimal pl-5">
                <li>Carichi il tuo estratto conto (PDF, CSV, XLS/XLSX, OFX, QIF).</li>
                <li>Il server lo converte in CSV standard (UTF‑8, separatore virgola, intestazioni).</li>
                <li>Scarichi il file pronto per l'import nel tuo gestionale.</li>
              </ol>
              <div class="mt-4 flex justify-end gap-2">
                <button id="close-dialog" class="px-3 py-2 text-sm rounded-lg border border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-800">Chiudi</button>
              </div>
            </div>
          </dialog>
        </div>
      </div>
    </main>

    <footer class="px-6 py-10 border-t border-slate-200/60 dark:border-slate-800/60">
      <div class="max-w-5xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-3 text-sm text-slate-500 dark:text-slate-400">
        <p>Self‑hosted • Nessun tracciamento • Privacy by design</p>
        <p>© <span id="year"></span> Estratti Conto → CSV</p>
      </div>
    </footer>

    <script>
      // Utilities
      const $ = (sel) => document.querySelector(sel);
      const formatBytes = (bytes) => {
        if (!bytes && bytes !== 0) return '—';
        const sizes = ['B','KB','MB','GB'];
        const i = Math.min(Math.floor(Math.log(Math.max(bytes,1)) / Math.log(1024)), sizes.length - 1);
        const value = bytes / Math.pow(1024, i);
        return `${value.toFixed(value < 10 && i > 0 ? 1 : 0)} ${sizes[i]}`;
      };

      const state = {
        file: null,
        controller: null,
        csvContent: '',
      };

      // Elements
      const dropzone = $('#dropzone');
      const fileInput = $('#file-input');
      const fileBadge = $('#file-badge');
      const fileNameEl = $('#file-name');
      const fileSizeEl = $('#file-size');
      const removeBtn = $('#remove-file');
      const convertBtn = $('#convert-btn');
      const resetBtn = $('#reset-btn');
      const progress = $('#progress');
      const progressBar = $('#progress-bar');
      const progressText = $('#progress-text');
      const alertBox = $('#alert');
      const result = $('#result');
      const downloadLink = $('#download-link');
      const copyBtn = $('#copy-btn');
      const csvPreview = $('#csv-preview');
      const previewLines = $('#preview-lines');
      const yearEl = $('#year');
      const how = $('#how-it-works');
      const dialog = $('#how-dialog');
      const closeDialog = $('#close-dialog');

      yearEl.textContent = new Date().getFullYear();

      // Dialog handlers
      how.addEventListener('click', (e) => { e.preventDefault(); dialog.showModal(); });
      closeDialog.addEventListener('click', () => dialog.close());

      // Copy button handler
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(state.csvContent);
          const originalText = copyBtn.querySelector('span').textContent;
          copyBtn.querySelector('span').textContent = 'Copiato!';
          setTimeout(() => {
            copyBtn.querySelector('span').textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error('Errore copia:', err);
          showAlert('Impossibile copiare negli appunti', 'error');
        }
      });

      // Drop handlers
      const accept = new Set(['pdf','csv','xls','xlsx','ofx','qif']);
      function isAccepted(file){
        const ext = file.name.split('.').pop().toLowerCase();
        return accept.has(ext);
      }

      function setFile(file){
        state.file = file;
        if(!file){
          fileBadge.classList.add('hidden');
          convertBtn.disabled = true;
          return;
        }
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = formatBytes(file.size);
        fileBadge.classList.remove('hidden');
        convertBtn.disabled = false;
      }

      dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('ring-2','ring-slate-400'); });
      dropzone.addEventListener('dragleave', () => dropzone.classList.remove('ring-2','ring-slate-400'));
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('ring-2','ring-slate-400');
        const f = e.dataTransfer.files?.[0];
        if(!f) return;
        if(!isAccepted(f)) return showAlert('Formato non supportato. Usa PDF, CSV, XLS/XLSX, OFX o QIF.', 'error');
        setFile(f);
      });

      // Non serve dropzone.click listener perché è già un <label for="file-input">
      fileInput.addEventListener('change', () => {
        const f = fileInput.files?.[0];
        if(!f) return;
        if(!isAccepted(f)) return showAlert('Formato non supportato. Usa PDF, CSV, XLS/XLSX, OFX o QIF.', 'error');
        setFile(f);
      });

      removeBtn.addEventListener('click', () => setFile(null));
      resetBtn.addEventListener('click', () => {
        setFile(null);
        hideAlert();
        progress.classList.add('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = 'Preparazione…';
        result.classList.add('hidden');
        fileInput.value = '';
      });

      function showAlert(message, type='info'){
        alertBox.textContent = message;
        alertBox.className = '';
        alertBox.classList.add('mt-6','rounded-xl','border','p-4','text-sm');
        if(type === 'error'){
          alertBox.classList.add('border-rose-300/60','dark:border-rose-700/60','bg-rose-50/60','dark:bg-rose-900/40','text-rose-800','dark:text-rose-100');
        } else if (type === 'success'){
          alertBox.classList.add('border-emerald-300/60','dark:border-emerald-700/60','bg-emerald-50/60','dark:bg-emerald-900/40');
        } else {
          alertBox.classList.add('border-slate-300/60','dark:border-slate-700/60','bg-slate-50/60','dark:bg-slate-900/40');
        }
        alertBox.classList.remove('hidden');
      }
      function hideAlert(){ alertBox.classList.add('hidden'); }

      // Conversion
      convertBtn.addEventListener('click', async () => {
        if(!state.file) return;
        hideAlert();
        result.classList.add('hidden');
        progress.classList.remove('hidden');
        progressBar.style.width = '15%';
        progressText.textContent = 'Caricamento…';

        try{
          const fd = new FormData();
          fd.append('file', state.file);

          // Optional: allow bank preset via query (?preset=bankId)
          const preset = new URLSearchParams(location.search).get('preset');
          if (preset) fd.append('preset', preset);

          // Abort handling
          state.controller = new AbortController();

          // NOTE: Cambia l'endpoint se necessario (reverse proxy, sottocartella, ecc.)
          const endpoint = '/api/convert';
          const res = await fetch(endpoint, {
            method: 'POST',
            body: fd,
            signal: state.controller.signal,
          });

          progressBar.style.width = '60%';
          progressText.textContent = 'Conversione in corso…';

          if(!res.ok){
            const contentType = res.headers.get('content-type') || '';
            let msg = `Errore ${res.status}`;
            if(contentType.includes('application/json')){
              const data = await res.json().catch(()=>null);
              if(data?.error) msg = data.error;
            } else {
              const text = await res.text().catch(()=>null);
              if(text) msg = text;
            }
            throw new Error(msg);
          }

          const blob = await res.blob();
          progressBar.style.width = '90%';
          progressText.textContent = 'Finalizzazione…';

          // Read blob content for preview
          const csvText = await blob.text();
          state.csvContent = csvText;

          // Prepare download
          const url = URL.createObjectURL(blob);
          const baseName = state.file.name.replace(/\.[^.]+$/, '') || 'estratto';
          downloadLink.href = url;
          downloadLink.setAttribute('download', `${baseName}-converted.csv`);

          // Populate preview
          csvPreview.textContent = csvText;
          const lineCount = csvText.split('\n').filter(l => l.trim()).length;
          previewLines.textContent = `${lineCount} righe`;

          result.classList.remove('hidden');
          progressBar.style.width = '100%';
          progressText.textContent = 'Fatto!';
          showAlert('Conversione completata con successo.', 'success');
        } catch (err){
          console.error(err);
          showAlert(`Conversione fallita: ${err.message || err}`, 'error');
        } finally {
          setTimeout(()=>{ progress.classList.add('hidden'); progressBar.style.width = '0%'; }, 900);
          state.controller = null;
        }
      });

      // Optional: cancel with ESC
      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && state.controller){ state.controller.abort(); showAlert('Operazione annullata.', 'info'); }
      });
    </script>
  </body>
</html>